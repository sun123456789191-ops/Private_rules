// 统一过滤正则（排除流量信息节点）
const COMMON_EXCLUDE = "(?i)(日期|过期|流量|expire|traffic|剩余|GB|TB|Countdown|剩余流量|倍率)";

function main(config) {
  // 1. 统一定义代理组
  const proxyGroups = [
    // === 应用场景分组 ===
    { name: "💬 即时通讯", type: "select", proxies: ["🇭🇰 香港节点", "🇯🇵 日本节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "🌐 社交媒体", type: "select", proxies: ["🇭🇰 香港节点", "🇯🇵 日本节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "🚀 GitHub", type: "select", proxies: ["🇭🇰 香港节点", "🇯🇵 日本节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择", "🎯 全球直连"] },
    
    // 以下组需要 include-all
    { name: "🤖 ChatGPT", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "🤖 Copilot", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择", "🎯 全球直连"] },
    { name: "🤖 AI服务", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "🎶 TikTok", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择", "🎯 全球直连"] },
    { name: "📹 YouTube", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇭🇰 香港节点", "🇯🇵 日本节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "🎥 Netflix", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "🎥 Emby", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择", "🎯 全球直连"] },
    { name: "📺 Bahamut", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇼🇸 台湾节点", "🚀 手动选择", "🎯 全球直连"] },
    { name: "🌎 国外媒体", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择", "🎯 全球直连"] },
    { name: "🛒 国外电商", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇺🇸 美国节点", "🇯🇵 日本节点", "🇭🇰 香港节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择", "🎯 全球直连"] },
    
    { name: "📢 谷歌FCM", type: "select", proxies: ["🇭🇰 香港节点", "🇯🇵 日本节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择", "🎯 全球直连", "DIRECT"] },
    { name: "🇬 谷歌服务", type: "select", proxies: ["🇭🇰 香港节点", "🇯🇵 日本节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择", "🎯 全球直连"] },
    { name: "🍎 苹果服务", type: "select", proxies: ["🎯 全球直连", "🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "Ⓜ️ 微软服务", type: "select", proxies: ["🎯 全球直连", "🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "🎮 游戏平台", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🎯 全球直连", "🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },
    { name: "🎮 Steam", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🎯 全球直连", "🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🚀 手动选择"] },

    // === 核心调度组 ===
    { name: "♻️ 自动选择", type: "url-test", url: "https://www.gstatic.com/generate_204", interval: 300, tolerance: 50, "include-all": true, "exclude-filter": COMMON_EXCLUDE },
    { name: "🎯 全球直连", type: "select", proxies: ["DIRECT"] },
    { name: "🚀 手动选择", type: "select", "include-all": true, "exclude-filter": COMMON_EXCLUDE, proxies: ["🇭🇰 香港节点", "🇯🇵 日本节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择"] },
    { name: "🐟 遵循规则", type: "select", proxies: ["🐟 漏网之鱼"] },
    { name: "🔀 非标端口", type: "select", proxies: ["🎯 全球直连", "🐟 遵循规则"] },
    { name: "🐟 漏网之鱼", type: "select", proxies: ["🚀 手动选择", "🇯🇵 日本节点", "🇭🇰 香港节点", "🇺🇸 美国节点", "🇸🇬 新加坡节点", "🇼🇸 台湾节点", "🇰🇷 韩国节点", "🌐 其他地区", "♻️ 自动选择", "🎯 全球直连"] },

    // === 核心区域节点组 ===
    { name: "🇭🇰 香港节点", type: "url-test", url: "https://www.gstatic.com/generate_204", interval: 300, tolerance: 50, "include-all": true, filter: "(?i)(港|HK|hk|Hong Kong|HongKong|hongkong|深港)" },
    { name: "🇺🇸 美国节点", type: "url-test", url: "https://www.gstatic.com/generate_204", interval: 300, tolerance: 50, "include-all": true, filter: "(?i)(美|波特兰|达拉斯|俄勒冈|凤凰城|费利蒙|硅谷|拉斯维加斯|洛杉矶|圣何塞|圣克拉拉|西雅图|芝加哥|\\bUS\\b|USA|United States|UnitedStates)" },
    { name: "🇯🇵 日本节点", type: "url-test", url: "https://www.gstatic.com/generate_204", interval: 300, tolerance: 50, "include-all": true, filter: "(?i)(日本|川日|东京|大阪|泉日|埼玉|沪日|深日|(?<!尼|-)日|JP|Japan|🇯🇵)" },
    { name: "🇸🇬 新加坡节点", type: "url-test", url: "https://www.gstatic.com/generate_204", interval: 300, tolerance: 50, "include-all": true, filter: "(?i)(新加坡|坡|狮城|SG|Singapore)" },
    { name: "🇼🇸 台湾节点", type: "url-test", url: "https://www.gstatic.com/generate_204", interval: 300, tolerance: 50, "include-all": true, filter: "(?i)(台|新北|彰化|TW|Taiwan)" },
    { name: "🇰🇷 韩国节点", type: "url-test", url: "https://www.gstatic.com/generate_204", interval: 300, tolerance: 50, "include-all": true, filter: "(?i)(KR|Korea|KOR|首尔|韩|韓)" },
    { 
      name: "🌐 其他地区", 
      type: "select", 
      "include-all": true, 
      proxies: [],
      "exclude-filter": "(?i)(港|HK|hk|Hong Kong|HongKong|hongkong|深港|美|波特兰|达拉斯|俄勒冈|凤凰城|费利蒙|硅谷|拉斯维加斯|洛杉矶|圣何塞|圣克拉拉|西雅图|芝加哥|\\bUS\\b|USA|United States|UnitedStates|日本|川日|东京|大阪|泉日|埼玉|沪日|深日|(?<!尼|-)日|JP|Japan|🇯🇵|新加坡|坡|狮城|SG|Singapore|台|新北|彰化|TW|Taiwan|KR|Korea|KOR|首尔|韩|韓|日期|过期|到期|流量|expire|traffic|剩余|GB|TB|Countdown|剩余流量|倍率|套餐)"
    }
  ];

  config["proxy-groups"] = proxyGroups;

  // 2. 规则提供者
  config["rule-providers"] = {
    "Custom_Direct": { "type": "http", "behavior": "classical", "url": "https://testingcf.jsdelivr.net/gh/Aethersailor/Custom_OpenClash_Rules@main/rule/Custom_Direct_Classical.yaml", "path": "./ruleset/Custom_Direct.yaml", "interval": 28800, "format": "text" },
    "Custom_Proxy": { "type": "http", "behavior": "classical", "url": "https://testingcf.jsdelivr.net/gh/Aethersailor/Custom_OpenClash_Rules@main/rule/Custom_Proxy_Classical.yaml", "path": "./ruleset/Custom_Proxy.yaml", "interval": 28800, "format": "text" },
    "Steam_CDN": { "type": "http", "behavior": "classical", "url": "https://testingcf.jsdelivr.net/gh/Aethersailor/Custom_OpenClash_Rules@main/rule/Steam_CDN_Classical.yaml", "path": "./ruleset/Steam_CDN.yaml", "interval": 28800, "format": "text" },
    "Custom_Port_Direct": { "type": "http", "behavior": "classical", "url": "https://testingcf.jsdelivr.net/gh/Aethersailor/Custom_OpenClash_Rules@main/rule/Custom_Port_Direct.yaml", "path": "./ruleset/Custom_Port_Direct.yaml", "interval": 28800, "format": "text" }
  };

  // 3. 规则
  config["rules"] = [
    "GEOSITE,private,🎯 全球直连",
    "GEOIP,private,🎯 全球直连,no-resolve",
    "RULE-SET,Custom_Direct,🎯 全球直连",
    "RULE-SET,Custom_Proxy,🚀 手动选择",
    "GEOSITE,google-cn,🎯 全球直连",
    "GEOSITE,category-games@cn,🎯 全球直连",
    "RULE-SET,Steam_CDN,🎯 全球直连",
    "GEOSITE,category-game-platforms-download,🎯 全球直连",
    "GEOSITE,category-public-tracker,🎯 全球直连",
    "GEOSITE,category-communication,💬 即时通讯",
    "GEOSITE,category-social-media-!cn,🌐 社交媒体",
    "GEOSITE,openai,🤖 ChatGPT",
    "GEOSITE,bing,🤖 Copilot",
    "GEOSITE,category-ai-!cn,🤖 AI服务",
    "GEOSITE,github,🚀 GitHub",
    "GEOSITE,steam,🎮 Steam",
    "GEOSITE,youtube,📹 YouTube",
    "GEOSITE,apple,🍎 苹果服务",
    "GEOSITE,microsoft,Ⓜ️ 微软服务",
    "GEOSITE,googlefcm,📢 谷歌FCM",
    "GEOSITE,google,🇬 谷歌服务",
    "GEOSITE,tiktok,🎶 TikTok",
    "GEOSITE,netflix,🎥 Netflix",
    "GEOSITE,category-emby,🎥 Emby",
    "GEOSITE,bahamut,📺 Bahamut",
    "GEOSITE,category-games,🎮 游戏平台",
    "GEOSITE,category-entertainment,🌎 国外媒体",
    "GEOSITE,category-ecommerce,🛒 国外电商",
    "GEOSITE,gfw,🚀 手动选择",
    "GEOIP,telegram,💬 即时通讯,no-resolve",
    "GEOIP,twitter,🌐 社交媒体,no-resolve",
    "GEOIP,facebook,🌐 社交媒体,no-resolve",
    "GEOIP,google,🇬 谷歌服务,no-resolve",
    "GEOIP,netflix,🎥 Netflix,no-resolve",
    "GEOSITE,cn,🎯 全球直连",
    "GEOIP,cn,🎯 全球直连,no-resolve",
    "RULE-SET,Custom_Port_Direct,🔀 非标端口",
    "MATCH,🐟 漏网之鱼"
  ];

  return config;
}
